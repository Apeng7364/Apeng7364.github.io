<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"apeng.re","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.18.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="比赛时间：4月29日-4月30日 XCTF联赛内的*ctf，由上海复旦大学******战队（sixstar）主办。 在De1ta打的这场比赛，最终第七名。re的题目ak，还做了个misc，还是有点小高兴。 总体体验还是不错的，希望能多打打这种高水平的比赛，继续磨练！ 下载地址">
<meta property="og:type" content="article">
<meta property="og:title" content="2019 *CTF">
<meta property="og:url" content="http://apeng.re/2019/05/02/2019starctf/index.html">
<meta property="og:site_name" content="Apeng&#39;s blog">
<meta property="og:description" content="比赛时间：4月29日-4月30日 XCTF联赛内的*ctf，由上海复旦大学******战队（sixstar）主办。 在De1ta打的这场比赛，最终第七名。re的题目ak，还做了个misc，还是有点小高兴。 总体体验还是不错的，希望能多打打这种高水平的比赛，继续磨练！ 下载地址">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://apeng.re/2019/05/02/2019starctf/2019starctf01.jpg">
<meta property="article:published_time" content="2019-05-02T08:29:44.000Z">
<meta property="article:modified_time" content="2023-03-24T14:14:17.028Z">
<meta property="article:author" content="Apeng">
<meta property="article:tag" content="Go">
<meta property="article:tag" content="花指令">
<meta property="article:tag" content="香农-范诺编码">
<meta property="article:tag" content="混淆">
<meta property="article:tag" content="词法分析器">
<meta property="article:tag" content="lsb">
<meta property="article:tag" content="zip">
<meta property="article:tag" content="doc">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://apeng.re/2019/05/02/2019starctf/2019starctf01.jpg">


<link rel="canonical" href="http://apeng.re/2019/05/02/2019starctf/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://apeng.re/2019/05/02/2019starctf/","path":"/2019/05/02/2019starctf/","title":"2019 *CTF"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>2019 *CTF | Apeng's blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="Apeng's blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Apeng's blog</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Reverse Everything</p>
      <img class="custom-logo-image" src="/uploads/custom-logo.png" alt="Apeng's blog">
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#re"><span class="nav-number">1.</span> <span class="nav-text">RE</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#fanogo"><span class="nav-number">1.1.</span> <span class="nav-text">fanoGO</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#yy"><span class="nav-number">1.2.</span> <span class="nav-text">yy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#obfuscating-macros-ii"><span class="nav-number">1.3.</span> <span class="nav-text">Obfuscating Macros II</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#matrix"><span class="nav-number">1.4.</span> <span class="nav-text">matrix</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%A8%8B%E5%BA%8F%E6%B5%81%E7%A8%8B"><span class="nav-number">1.4.1.</span> <span class="nav-text">程序流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AE%97%E6%B3%95"><span class="nav-number">1.4.2.</span> <span class="nav-text">算法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%A9%B7%E4%B8%BE%E6%B1%82%E8%A7%A3"><span class="nav-number">1.4.3.</span> <span class="nav-text">穷举求解</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">1.4.4.</span> <span class="nav-text">总结</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#misc"><span class="nav-number">2.</span> <span class="nav-text">misc</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#she"><span class="nav-number">2.1.</span> <span class="nav-text">she</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#otaku"><span class="nav-number">2.2.</span> <span class="nav-text">otaku</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Apeng</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">31</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">59</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/Apeng7364" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Apeng7364" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:apeng622@gmail.com" title="E-Mail → mailto:apeng622@gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/Apeng_7364" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;Apeng_7364" rel="noopener me" target="_blank"><i class="fab fa-twitter fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml" rel="noopener me"><i class="fa fa-rss fa-fw"></i></a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/big/by_nc_nd.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
    </div>

    
    <div class="sidebar-inner sidebar-blogroll">
      <div class="links-of-blogroll animated">
        <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
          链接
        </div>
        <ul class="links-of-blogroll-list">
            <li class="links-of-blogroll-item">
              <a href="/friends" title="&#x2F;friends">Friends</a>
            </li>
        </ul>
      </div>
    </div>
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://apeng.re/2019/05/02/2019starctf/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Apeng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Apeng's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="2019 *CTF | Apeng's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          2019 *CTF
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-05-02 16:29:44" itemprop="dateCreated datePublished" datetime="2019-05-02T16:29:44+08:00">2019-05-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-03-24 22:14:17" itemprop="dateModified" datetime="2023-03-24T22:14:17+08:00">2023-03-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CTF-writeup/" itemprop="url" rel="index"><span itemprop="name">CTF writeup</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CTF-writeup/2019/" itemprop="url" rel="index"><span itemprop="name">2019</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>比赛时间：4月29日-4月30日</p>
<p>XCTF联赛内的*ctf，由上海复旦大学******战队（sixstar）主办。</p>
<p>在De1ta打的这场比赛，最终第七名。re的题目ak，还做了个misc，还是有点小高兴。</p>
<p>总体体验还是不错的，希望能多打打这种高水平的比赛，继续磨练！</p>
<p><a target="_blank" rel="noopener" href="https://github.com/Apeng7364/ctf/tree/master/ctf2019/starctf">下载地址</a></p>
<p><strong><span id="more"></span></strong></p>
<h2 id="re">RE</h2>
<h3 id="fanogo">fanoGO</h3>
<p>香农-范诺编码,decode之后要为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">If you cannot read all your books...fondle them---peer into them, let them fall open where they will, read from the first sentence that arrests the eye, set them back on the shelves with your own hands, arrange them on your own plan so that you at least know where they are. Let them be your friends; let them, at any rate, be your acquaintances.</span><br></pre></td></tr></table></figure>
<p>编码表根据一个txt生成，具体细节不清楚，直接在程序中找字典。</p>
<p>另外程序里存字典的方式很奇特，用一个结构体表示。</p>
<p><code>fano___Fano__Decode</code>是解码函数。一阵瞎调，最后在<code>000000000045C618</code>下断，rbx指向的就是解码字典的结构体，结构如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">00000000 dict struc ; (sizeof=0x30, mappedto_759)</span><br><span class="line">00000000 byte dq ?                               ; offset point to decoded byte</span><br><span class="line">00000008 unknown0 dq ?</span><br><span class="line">00000010 code dq ?                               ; offset the encoded code</span><br><span class="line">00000018 lenth dq ?                               ; char *   encoded lenth</span><br><span class="line">00000020 unknown1 dq ?</span><br><span class="line">00000028 unknown2 dq ?</span><br></pre></td></tr></table></figure>
<p>编码结果是从code指向的字符串开始的lenth位，我这里是手动复制出来在用文本处理得到字典的。。。
字典：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dic =&#123;<span class="string">&#x27; &#x27;</span>:<span class="string">&#x27;0001&#x27;</span>, <span class="string">&#x27;-&#x27;</span>:<span class="string">&#x27;00100100&#x27;</span>, <span class="string">&#x27;,&#x27;</span>:<span class="string">&#x27;0010001&#x27;</span>, <span class="string">&#x27;.&#x27;</span>:<span class="string">&#x27;00100101&#x27;</span>, <span class="string">&#x27;;&#x27;</span>:<span class="string">&#x27;001001111&#x27;</span>, <span class="string">&#x27;I&#x27;</span>:<span class="string">&#x27;00101011&#x27;</span>, <span class="string">&#x27;L&#x27;</span>:<span class="string">&#x27;00101100001&#x27;</span>, <span class="string">&#x27;a&#x27;</span>:<span class="string">&#x27;0011&#x27;</span>, <span class="string">&#x27;c&#x27;</span>:<span class="string">&#x27;010001&#x27;</span>, <span class="string">&#x27;b&#x27;</span>:<span class="string">&#x27;010000&#x27;</span>, <span class="string">&#x27;e&#x27;</span>:<span class="string">&#x27;0101&#x27;</span>, <span class="string">&#x27;d&#x27;</span>:<span class="string">&#x27;01001&#x27;</span>, <span class="string">&#x27;g&#x27;</span>:<span class="string">&#x27;01101&#x27;</span>, <span class="string">&#x27;f&#x27;</span>:<span class="string">&#x27;01100&#x27;</span>, <span class="string">&#x27;i&#x27;</span>:<span class="string">&#x27;1000&#x27;</span>, <span class="string">&#x27;h&#x27;</span>:<span class="string">&#x27;0111&#x27;</span>, <span class="string">&#x27;k&#x27;</span>:<span class="string">&#x27;1001001&#x27;</span>, <span class="string">&#x27;m&#x27;</span>:<span class="string">&#x27;10011&#x27;</span>, <span class="string">&#x27;l&#x27;</span>:<span class="string">&#x27;100101&#x27;</span>, <span class="string">&#x27;o&#x27;</span>:<span class="string">&#x27;10110&#x27;</span>, <span class="string">&#x27;n&#x27;</span>:<span class="string">&#x27;1010&#x27;</span>, <span class="string">&#x27;q&#x27;</span>:<span class="string">&#x27;11000&#x27;</span>, <span class="string">&#x27;p&#x27;</span>:<span class="string">&#x27;10111&#x27;</span>, <span class="string">&#x27;s&#x27;</span>:<span class="string">&#x27;1101&#x27;</span>, <span class="string">&#x27;r&#x27;</span>:<span class="string">&#x27;11001&#x27;</span>, <span class="string">&#x27;u&#x27;</span>:<span class="string">&#x27;111100&#x27;</span>, <span class="string">&#x27;t&#x27;</span>:<span class="string">&#x27;1110&#x27;</span>, <span class="string">&#x27;w&#x27;</span>:<span class="string">&#x27;1111100&#x27;</span>, <span class="string">&#x27;v&#x27;</span>:<span class="string">&#x27;111101&#x27;</span>, <span class="string">&#x27;y&#x27;</span>:<span class="string">&#x27;1111110&#x27;</span>&#125;</span><br></pre></td></tr></table></figure>
<p>注意到大于0x7f还有一些编码以及最终结束一般不会刚好凑齐8bit，猜测后面这些都是用来表示编码结束的。
之前的一段文字按字典编码后还剩4bit满一个字节，就找一个12bit的用来表示结束的编码
结束编码：111111100010
直接解码的时候所有不可见字符都被替换成了0xFD，就会出错
比如一开始的几个字符If you，编码后是：
00101011011000001111111010110111100 8bit一组： 00101011 0x2B 01100000
0x60 11111110 0xFE 10110111 0xB7 100......</p>
<p>前两个字节都能够照常解码，到了第三个字符第四个被莫名替换位0xFD了。
动调跟入解码过程，仔细看看过程。</p>
<p><code>fano_Bytes2Str</code>函数的作用是字节转二进制字符串，在里面发现一个go的库函数<code>runtime_stringiter2</code>很可疑，进去的时候是0xFE，出来就变成0xFD了，跟进几步，发现他先校验当前字符是不是大于0x80，然后再根据后一位和后两位的数据修改，不满足某种规则会直接返回0xfffd，即变成0xfd。到这里就猜出有可能是utf8的编码问题。utf8是一种可变长的编码方式。</p>
<p>在<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/UTF-8">wiki</a>上可以看到unicode转utf-8的规则</p>
<blockquote>
<ul>
<li>Octal 0–177 (hex 0–7F) is coded with an unchanged single byte.</li>
<li>Octal 0200–3777 (hex 80–7FF) shall be coded with two bytes. xxyy
will be 3xx 2yy.</li>
</ul>
</blockquote>
<p>注意这里的八进制添加的3和2是按照每8bit结果看的，举个例子</p>
<p>FD将会变为 C3BD</p>
<p>11111101 375</p>
<p>补0</p>
<p>000 1111 1101 03 75</p>
<p>添加3和2，03 75变成303
275，如果直接把这个数转成2进制是不对的，因为303和275是独立的两部分，每个单独地转成8bit二进制数11000011和10111101</p>
<p><strong>110</strong>00011 <strong>10</strong>111101 303 275</p>
<p>结果</p>
<p>C3 BD 1100001110111101 141675</p>
<p>也可以按百度百科的方法，补3个0然后填入110X XXXX 10XX XXXX中。
比赛时我是手动写了一个unicode到utf8的转换。赛后发现可以直接用unichr和encode转。。。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;error&#x27;</span></span><br><span class="line">p = remote(<span class="string">&#x27;34.92.37.22&#x27;</span>,<span class="string">&#x27;10001&#x27;</span>)</span><br><span class="line">dic =&#123;<span class="string">&#x27; &#x27;</span>:<span class="string">&#x27;0001&#x27;</span>, <span class="string">&#x27;-&#x27;</span>:<span class="string">&#x27;00100100&#x27;</span>, <span class="string">&#x27;,&#x27;</span>:<span class="string">&#x27;0010001&#x27;</span>, <span class="string">&#x27;.&#x27;</span>:<span class="string">&#x27;00100101&#x27;</span>, <span class="string">&#x27;;&#x27;</span>:<span class="string">&#x27;001001111&#x27;</span>, <span class="string">&#x27;I&#x27;</span>:<span class="string">&#x27;00101011&#x27;</span>, <span class="string">&#x27;L&#x27;</span>:<span class="string">&#x27;00101100001&#x27;</span>, <span class="string">&#x27;a&#x27;</span>:<span class="string">&#x27;0011&#x27;</span>, <span class="string">&#x27;c&#x27;</span>:<span class="string">&#x27;010001&#x27;</span>, <span class="string">&#x27;b&#x27;</span>:<span class="string">&#x27;010000&#x27;</span>, <span class="string">&#x27;e&#x27;</span>:<span class="string">&#x27;0101&#x27;</span>, <span class="string">&#x27;d&#x27;</span>:<span class="string">&#x27;01001&#x27;</span>, <span class="string">&#x27;g&#x27;</span>:<span class="string">&#x27;01101&#x27;</span>, <span class="string">&#x27;f&#x27;</span>:<span class="string">&#x27;01100&#x27;</span>, <span class="string">&#x27;i&#x27;</span>:<span class="string">&#x27;1000&#x27;</span>, <span class="string">&#x27;h&#x27;</span>:<span class="string">&#x27;0111&#x27;</span>, <span class="string">&#x27;k&#x27;</span>:<span class="string">&#x27;1001001&#x27;</span>, <span class="string">&#x27;m&#x27;</span>:<span class="string">&#x27;10011&#x27;</span>, <span class="string">&#x27;l&#x27;</span>:<span class="string">&#x27;100101&#x27;</span>, <span class="string">&#x27;o&#x27;</span>:<span class="string">&#x27;10110&#x27;</span>, <span class="string">&#x27;n&#x27;</span>:<span class="string">&#x27;1010&#x27;</span>, <span class="string">&#x27;q&#x27;</span>:<span class="string">&#x27;11000&#x27;</span>, <span class="string">&#x27;p&#x27;</span>:<span class="string">&#x27;10111&#x27;</span>, <span class="string">&#x27;s&#x27;</span>:<span class="string">&#x27;1101&#x27;</span>, <span class="string">&#x27;r&#x27;</span>:<span class="string">&#x27;11001&#x27;</span>, <span class="string">&#x27;u&#x27;</span>:<span class="string">&#x27;111100&#x27;</span>, <span class="string">&#x27;t&#x27;</span>:<span class="string">&#x27;1110&#x27;</span>, <span class="string">&#x27;w&#x27;</span>:<span class="string">&#x27;1111100&#x27;</span>, <span class="string">&#x27;v&#x27;</span>:<span class="string">&#x27;111101&#x27;</span>, <span class="string">&#x27;y&#x27;</span>:<span class="string">&#x27;1111110&#x27;</span>&#125;</span><br><span class="line">plain = <span class="string">&#x27;If you cannot read all your books...fondle them---peer into them, let them fall open where they will, read from the first sentence that arrests the eye, set them back on the shelves with your own hands, arrange them on your own plan so that you at least know where they are. Let them be your friends; let them, at any rate, be your acquaintances.&#x27;</span></span><br><span class="line"></span><br><span class="line">cipher = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(plain)):</span><br><span class="line">   cipher+=dic[plain[i]]</span><br><span class="line">s = <span class="string">&#x27;&#x27;</span></span><br><span class="line">cipher+=<span class="string">&#x27;111111100010&#x27;</span></span><br><span class="line"><span class="comment"># print(cipher)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string"># my unicode to utf8</span></span><br><span class="line"><span class="string">for i in range(0,len(cipher),8):</span></span><br><span class="line"><span class="string">   temp = eval(&#x27;0b&#x27;+cipher[i:i+8])</span></span><br><span class="line"><span class="string">   if temp&gt;=0x80:</span></span><br><span class="line"><span class="string">       res = &#x27;000&#x27;+bin(temp)[2:]</span></span><br><span class="line"><span class="string">       res = &#x27;110&#x27;+res[0:5]+&#x27;10&#x27;+res[5:]</span></span><br><span class="line"><span class="string">       a = res[0:8]</span></span><br><span class="line"><span class="string">       b = res[8:]</span></span><br><span class="line"><span class="string">       s+=chr(eval(&#x27;0b&#x27;+a))</span></span><br><span class="line"><span class="string">       s+=chr(eval(&#x27;0b&#x27;+b))</span></span><br><span class="line"><span class="string">   else:</span></span><br><span class="line"><span class="string">       s+=chr(temp)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>        </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="built_in">len</span>(cipher),<span class="number">8</span>):</span><br><span class="line">   temp = <span class="built_in">eval</span>(<span class="string">&#x27;0b&#x27;</span>+cipher[i:i+<span class="number">8</span>])</span><br><span class="line">   s+=unichr(temp)</span><br><span class="line">s = s.encode(<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line"><span class="comment"># p = process(&#x27;fanoGo&#x27;)</span></span><br><span class="line">p.recvuntil(<span class="string">&#x27;:\n&#x27;</span>)</span><br><span class="line">p.send(s)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">   <span class="built_in">print</span>(p.recv())</span><br><span class="line"><span class="keyword">except</span> EOFError:</span><br><span class="line">   p.close()</span><br></pre></td></tr></table></figure>
<p>*CTF{NUY4a3E5D9186hVzejoyItr7xHBcmOpv}</p>
<h3 id="yy">yy</h3>
<p>Ch4r1l3师傅先做了一部分，看了下文档继续往后做的。</p>
<blockquote>
<p>看了下程序的逻辑，大概是 利用yacc进行词法解析，解析到的东西存到buffer
然后buffer再用encrypt这个函数进行加密，最后加密的结果与cmp进行比较
encrypt是用aes加密 测试了下，大概规则为
*CTF{xxxx}，中间的xxx范围大概为0-9,a-z
然后大概解了下逻辑，那个switch里面那堆从上到下就是a-z 0-9
encrypt是用标准aes加密，用的密钥是提前生成好了，在bss段key开始的176个字节
很迷的就是，它比较是0xa0个字节.......但是很明显flag没那么长
感觉encrypt这个函数应该会被调用多次，但是实际调试的时候只调了一次？
encrypt使用了一个全局变量cnt，用来记录加密了的长度</p>
</blockquote>
<p>顺着Ch4r1l3师傅的思路，我看了一下词法解析的过程。</p>
<p>在词法分析器<code>yylex</code>中，找到了一个叫<code>yy_ec</code>的table，大小256，每个元素对应一个字节，除了测试过程中输入有效的字符*CTF{}0-9a-z外，大部分都为1，仔细看了一下发现漏了个下划线不为1。调试了一下发现，输入下划线后会对下一部分重新aes加密。做题过程中发现了每次加密都会异或之前一次的加密结果，其实这就是cbc加密模式。之前一直没了解过，所以是手动写的这个异或过程=
=</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">strxor</span>(<span class="params">s1,s2</span>):</span><br><span class="line">    s = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(s1)):</span><br><span class="line">        s+=<span class="built_in">chr</span>(<span class="built_in">ord</span>(s1[i])^<span class="built_in">ord</span>(s2[i]))</span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line">key = <span class="string">&#x27;2B7E151628AED2A6ABF7158809CF4F3C&#x27;</span>.decode(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line">aes = AES.new(key)</span><br><span class="line">cipher = [<span class="string">&#x27;AE4614F82A40CF5031D3FE048C061212&#x27;</span>.decode(<span class="string">&#x27;hex&#x27;</span>),</span><br><span class="line"><span class="string">&#x27;23FAC726E861D9C3A93C45701AC7F03D&#x27;</span>.decode(<span class="string">&#x27;hex&#x27;</span>),</span><br><span class="line"><span class="string">&#x27;DFBEBC16AB6E37AC148B9C94F75D6278&#x27;</span>.decode(<span class="string">&#x27;hex&#x27;</span>),</span><br><span class="line"><span class="string">&#x27;FC16981DB231D35ADC3A60869ACA7BA3&#x27;</span>.decode(<span class="string">&#x27;hex&#x27;</span>),</span><br><span class="line"><span class="string">&#x27;B5D5F1B2D9FFD209D477D73DC0561902&#x27;</span>.decode(<span class="string">&#x27;hex&#x27;</span>),</span><br><span class="line"><span class="string">&#x27;B69B426CE8A277E399AC324091A92A86&#x27;</span>.decode(<span class="string">&#x27;hex&#x27;</span>),</span><br><span class="line"><span class="string">&#x27;F3FA473CC35C419BE80507D0D4305A9E&#x27;</span>.decode(<span class="string">&#x27;hex&#x27;</span>),</span><br><span class="line"><span class="string">&#x27;8D529BA3FBADB6443F72839C2277FE48&#x27;</span>.decode(<span class="string">&#x27;hex&#x27;</span>),</span><br><span class="line"><span class="string">&#x27;FE868412004EEDFFAC441923841F12CA&#x27;</span>.decode(<span class="string">&#x27;hex&#x27;</span>)]</span><br><span class="line">dic = &#123;<span class="string">&#x27;\x82&#x27;</span>:<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;\x05&#x27;</span>:<span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;\x86&#x27;</span>:<span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;\x8A&#x27;</span>:<span class="string">&#x27;d&#x27;</span>, <span class="string">&#x27;\x0B&#x27;</span>:<span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;\x11&#x27;</span>:<span class="string">&#x27;f&#x27;</span>, <span class="string">&#x27;\x96&#x27;</span>:<span class="string">&#x27;g&#x27;</span>, <span class="string">&#x27;\x1D&#x27;</span>:<span class="string">&#x27;h&#x27;</span>, <span class="string">&#x27;\x27&#x27;</span>:<span class="string">&#x27;i&#x27;</span>, <span class="string">&#x27;\xA9&#x27;</span>:<span class="string">&#x27;j&#x27;</span>, <span class="string">&#x27;\x2B&#x27;</span>:<span class="string">&#x27;k&#x27;</span>, <span class="string">&#x27;\xB1&#x27;</span>:<span class="string">&#x27;l&#x27;</span>, <span class="string">&#x27;\xF3&#x27;</span>:<span class="string">&#x27;m&#x27;</span>, <span class="string">&#x27;\x5E&#x27;</span>:<span class="string">&#x27;n&#x27;</span>, <span class="string">&#x27;\x37&#x27;</span>:<span class="string">&#x27;o&#x27;</span>, <span class="string">&#x27;\x38&#x27;</span>:<span class="string">&#x27;p&#x27;</span>, <span class="string">&#x27;\xC2&#x27;</span>:<span class="string">&#x27;q&#x27;</span>, <span class="string">&#x27;\x47&#x27;</span>:<span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;\x4E&#x27;</span>:<span class="string">&#x27;s&#x27;</span>, <span class="string">&#x27;\x4F&#x27;</span>:<span class="string">&#x27;t&#x27;</span>, <span class="string">&#x27;\xD6&#x27;</span>:<span class="string">&#x27;u&#x27;</span>, <span class="string">&#x27;\x58&#x27;</span>:<span class="string">&#x27;v&#x27;</span>, <span class="string">&#x27;\xDE&#x27;</span>:<span class="string">&#x27;w&#x27;</span>, <span class="string">&#x27;\xE2&#x27;</span>:<span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;\xE5&#x27;</span>:<span class="string">&#x27;y&#x27;</span>, <span class="string">&#x27;\xE6&#x27;</span>:<span class="string">&#x27;z&#x27;</span>, <span class="string">&#x27;\x67&#x27;</span>:<span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;\x6B&#x27;</span>:<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;\xEC&#x27;</span>:<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;\xED&#x27;</span>:<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;\x6F&#x27;</span>:<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;\xF2&#x27;</span>:<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;\x73&#x27;</span>:<span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;\xF5&#x27;</span>:<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;\x77&#x27;</span>:<span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;\x7F&#x27;</span>: <span class="string">&#x27;9&#x27;</span>&#125;</span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line">xor = <span class="string">&#x27;00&#x27;</span>*<span class="number">16</span></span><br><span class="line">xor = xor.decode(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(cipher)):</span><br><span class="line">    temp = cipher[i]</span><br><span class="line">    plain = aes.decrypt(temp)</span><br><span class="line">    plainp = strxor(plain,xor)</span><br><span class="line">    xor = cipher[i]</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> plainp:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            flag+=dic[j]</span><br><span class="line">        <span class="keyword">except</span> KeyError:</span><br><span class="line">            flag+=<span class="string">&#x27;_&#x27;</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">flag = <span class="string">&#x27;*CTF&#123;&#x27;</span>+flag[:-<span class="number">1</span>]+<span class="string">&#x27;&#125;&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure>
<p>得到*CTF{yy_funct10nl_1s_h4rd_andc_n0_n33d_to_r3v3rs3}</p>
<p>然而提交不对，本地输入flag后返回congratulations。分析一下flag的语义，funct10n后面多了个l，and后面多了个c，去掉之后再提交就对了</p>
<p>原因：加密时每次用append：6124258631AB6EAFB114FE76783D1EFF填充明文，然后用输入映射的字节依次填充。append的字节在box里刚好有，比如B1对应字符l，86对应字符c，刚好跟我们求得一样。如果对应位置刚好是那个字符就会造成重复而多解。</p>
<p>最终flag： *CTF{yy_funct10n_1s_h4rd_and_n0_n33d_to_r3v3rs3}</p>
<h3 id="obfuscating-macros-ii">Obfuscating Macros II</h3>
<p>ddctf Obfuscating
Macros的升级版，强化了算法。由于之前打ddctf的时候稍微分析了一下，比较上手一点。</p>
<p>混淆还是去不掉，只能硬调
首先随便输入个长度16的字符串，加密在<code>sub_401006</code>里。输入的16个字节分成了两个__int64，作为参数传进函数，幅值给v6
v7，推荐的做法是查找v6和v7的引用，在所有引用的地方下断，<code>sub_4045F2</code>和<code>sub_4043C0</code>的引用不下断点。同时分析一下发现，v8是计算过程中的中间变量，也查找引用并下断点。</p>
<p>同时，根据打ddctf的经验，形如sub rax,
4的指令比较关键，控制了程序执行的流程。在函数内发现了两处这种可疑的语句，对应的反汇编分别是</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( v7 &amp; <span class="number">1</span> )</span><br><span class="line">  v14 -= <span class="number">4LL</span>;</span><br></pre></td></tr></table></figure>
<p>和</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( v16 &lt;= <span class="number">0x3FF</span> )</span><br><span class="line">  v15 -= <span class="number">3LL</span>;</span><br></pre></td></tr></table></figure>
<p>查找一下v16的引用，都下好断点。</p>
<p>这里其实不难猜出这是个循环，有赋初值0，有增量v16++，也有判定v16&lt;=0x3FF。</p>
<p>这两处调试的时候应该重点关照一下。</p>
<p>下好断点，开调，注意时刻观察栈上v6和v7的变化情况。</p>
<p>由于加密是分两部分加密的，所以我们干脆两部分都输入为同一字符，这里输入了11111111aaaaaaaa</p>
<p>v6 = 'aaaaaaaa'，v7 = '11111111'</p>
<p>果然首先来到v16 =
0，然后是判定v16&lt;=0x3ff，接下来只要再回到这里就是一个循环了。</p>
<p>然后是v8 = ~v7</p>
<p>接下来来到了if(v7&amp;1)，这里为真，接下来边来到v8^=*v5，观看一下v8和v5的内容，发现v8变成了v6,v5指向v7，再下来其实是v6
= v8，然后是v7 =
~v7。接下来的执行流程不难看出是把整个128位的数循环左移了一位。从栈上的结果不难看出，这里的循环左移是按照v6在高位，v7在低位。</p>
<p>之后也没什么分支了，都是一条线直到循环结束。</p>
<p>整个循环内有分支的只有最开始的(v7&amp;1)，由于我们输入的最低位是1，这回输入个最低位位0的试试，我们输入00000000aaaaaaaa</p>
<p>与之前不同的，判定完(v7&amp;1)的结果位0后，v8^=*v5这里，v8还是v6，而v5变成了指向~v7，再往后都一样了。</p>
<p>不难写出加密算法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">rol</span>(<span class="params">a,b</span>):</span><br><span class="line">    tmp1 = (a&amp;<span class="number">0x8000000000000000</span>)//<span class="number">0x8000000000000000</span></span><br><span class="line">    tmp2 = (b&amp;<span class="number">0x8000000000000000</span>)//<span class="number">0x8000000000000000</span></span><br><span class="line">    a = a &lt;&lt; <span class="number">1</span></span><br><span class="line">    b = b &lt;&lt; <span class="number">1</span></span><br><span class="line">    a |= tmp2</span><br><span class="line">    b |= tmp1</span><br><span class="line">    a&amp;=<span class="number">0xffffffffffffffff</span></span><br><span class="line">    b&amp;=<span class="number">0xffffffffffffffff</span></span><br><span class="line">    <span class="keyword">return</span> a,b</span><br><span class="line"></span><br><span class="line">a = <span class="number">0x6161616161616161</span></span><br><span class="line">b = <span class="number">0x3030303030303030</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x400</span>):</span><br><span class="line">    <span class="keyword">if</span> b&amp;<span class="number">1</span>:</span><br><span class="line">        a^=b</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        a^=(~b)</span><br><span class="line">    b = ~b</span><br><span class="line">    a &amp;= <span class="number">0xffffffffffffffff</span></span><br><span class="line">    b &amp;= <span class="number">0xffffffffffffffff</span></span><br><span class="line">    a,b = rol(a,b)</span><br><span class="line">    tmp = a</span><br><span class="line">    a = a+b</span><br><span class="line">    b = tmp</span><br><span class="line">    a,b = rol(a,b)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(a))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(b))</span><br></pre></td></tr></table></figure>
<p>解密算法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">ror</span>(<span class="params">a,b</span>):</span><br><span class="line">    tmp1 = (a&amp;<span class="number">1</span>)*<span class="number">0x8000000000000000</span></span><br><span class="line">    tmp2 = (b&amp;<span class="number">1</span>)*<span class="number">0x8000000000000000</span></span><br><span class="line">    a = a &gt;&gt; <span class="number">1</span></span><br><span class="line">    b = b &gt;&gt; <span class="number">1</span></span><br><span class="line">    a |= tmp2</span><br><span class="line">    b |= tmp1</span><br><span class="line">    a&amp;=<span class="number">0xffffffffffffffff</span></span><br><span class="line">    b&amp;=<span class="number">0xffffffffffffffff</span></span><br><span class="line">    <span class="keyword">return</span> a,b</span><br><span class="line"></span><br><span class="line">a = <span class="number">0x50A2DCC51ED6C4A2</span></span><br><span class="line">b = <span class="number">0xA1E8895EB916B732</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x400</span>):</span><br><span class="line">    a, b = ror(a, b)</span><br><span class="line">    tmp = b</span><br><span class="line">    b = (a - b) &amp; <span class="number">0xffffffffffffffff</span></span><br><span class="line">    a = tmp</span><br><span class="line">    a, b = ror(a, b)</span><br><span class="line">    <span class="keyword">if</span> b&amp;<span class="number">1</span>:</span><br><span class="line">        a^=b</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        a^=(~b)</span><br><span class="line">    b = ~b</span><br><span class="line">    a&amp;=<span class="number">0xffffffffffffffff</span></span><br><span class="line">    b&amp;=<span class="number">0xffffffffffffffff</span></span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    tmp = b&amp;<span class="number">0xff</span></span><br><span class="line">    b&gt;&gt;=<span class="number">8</span></span><br><span class="line">    flag+=<span class="built_in">chr</span>(tmp)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    tmp = a&amp;<span class="number">0xff</span></span><br><span class="line">    a&gt;&gt;=<span class="number">8</span></span><br><span class="line">    flag+=<span class="built_in">chr</span>(tmp)    </span><br><span class="line"><span class="built_in">print</span>(flag)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>*CTF{fUnfl@tCf9}</p>
<p>对于去混淆，我自身angr还是没有研究透彻，我就不班门弄斧了，期待一个大佬讲解</p>
<h3 id="matrix">matrix</h3>
<p>看了下有很多冗余代码和花指令，然而没写过去除冗余代码的脚本，花指令倒是写了个脚本去除：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">bg = <span class="number">0x000027A0</span></span><br><span class="line">end = <span class="number">0x00010B80</span></span><br><span class="line">main_return = <span class="number">0x00005C10</span></span><br><span class="line">addr = bg</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;start at %08x&#x27;</span>%addr)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">patch_nop</span>(<span class="params">begin,end</span>):</span><br><span class="line">    <span class="keyword">while</span>(end&gt;begin):</span><br><span class="line">        PatchByte(begin,<span class="number">0x90</span>)</span><br><span class="line">        begin=begin+<span class="number">1</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">next_instr</span>(<span class="params">addr</span>):</span><br><span class="line">    <span class="keyword">return</span> addr+ItemSize(addr)</span><br><span class="line"><span class="keyword">while</span>(addr&lt;end):</span><br><span class="line">    next_addr =next_instr(addr)</span><br><span class="line">    MakeCode(next_addr)</span><br><span class="line">    addr = next_instr(addr)</span><br><span class="line">    MakeCode(addr)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;jmp     $+5&#x27;</span> <span class="keyword">in</span> GetDisasm(addr):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;ret :%08x&#x27;</span>%addr)</span><br><span class="line">        patch_nop(addr,addr+<span class="number">5</span>)</span><br><span class="line">        PatchByte(addr + <span class="number">6</span>,<span class="number">0xC3</span>)</span><br><span class="line">        patch_nop(addr + <span class="number">7</span>, addr + <span class="number">9</span>)</span><br><span class="line">        addr = addr + <span class="number">9</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;xor&#x27;</span> <span class="keyword">in</span> GetDisasm(addr) <span class="keyword">and</span> GetOpnd(addr,<span class="number">0</span>) == GetOpnd(addr,<span class="number">1</span>) <span class="keyword">and</span> <span class="string">&#x27;jnz&#x27;</span> <span class="keyword">in</span> GetDisasm(addr + <span class="number">2</span>):</span><br><span class="line">        patch_nop(addr, addr + <span class="number">4</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;xor jmp: %08x&#x27;</span>%addr)</span><br><span class="line">        patch_nop(addr, addr + <span class="number">4</span>)</span><br><span class="line">        addr = addr + <span class="number">4</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;call    $+5&#x27;</span> <span class="keyword">in</span> GetDisasm(addr):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;nop: %08x&#x27;</span>%addr)</span><br><span class="line">        patch_nop(addr,addr+<span class="number">0xB</span>)</span><br><span class="line">        PatchByte(addr + <span class="number">0xA</span>, <span class="number">0xE8</span>)</span><br><span class="line">        addr = addr + <span class="number">0xF</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;end&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>然而去掉之后仍然不能f5，于是开始对着汇编撸。。。</p>
<h4 id="程序流程">程序流程</h4>
<p>由于过程中有大量冗余代码，经常会干扰我们调试，所以要胆大心细，大胆的跳过一些无用的代码，找到真正有用的代码。</p>
<p>由于是动调的地址，我这里的基地址是0x56555000，可以根据这个偏移换算到0的地址。。。</p>
<p>首先能看到一些这样的跳转代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.text:56559FA3 cmp     ecx, eax</span><br><span class="line">.text:56559FA5 jge     loc_5655A2A0</span><br><span class="line">.text:56559FAB jmp     loc_5655A013</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>不难看出这是个循环。</p>
<p>输入后进入了第一个循环体，设内存断点跟一跟，或者直接断到跳出循环，可以发现它将输入的字符串转了hex。</p>
<p>之后在<code>5655A3A0</code>调用了函数<code>565589C7</code>，看一下栈内，参数就是转完hex的内容。</p>
<p>跟进函数，先看到一个循环，大小为字节的长度，继续跟进不难发现很多如下的代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.text:56558BCF cmp     ecx, eax</span><br><span class="line">.text:56558BD1 jnz     loc_56558C2A</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>...</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.text:56558C79 cmp     ecx, eax</span><br><span class="line">.text:56558C7B jnz     loc_56558CB5</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>...</p>
<p>这应该是个case或者是if elif elif ...</p>
<p>对比的是我们的输入和另外18个字节，提取出来，他们是：</p>
<p>10 15 11 14 12 13 20 25 21 24 22 23 30 35 31 34 32 33</p>
<p>如果相等的话，每个又会进入一个对应的函数，之后继续循环，如果不在这些字节之内，会直接返回。
先不管这18个函数干了什么，直接步过到返回。
紧跟着在<code>5655A3D0</code>调用了函数<code>56559638</code>，步入看看做了什么。
这里的循环跟之前的有些许不同：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.text:565596B0 cmp     eax, ecx</span><br><span class="line">.text:565596B2 jge     loc_56559E3D</span><br><span class="line">.text:565596B8 mov     eax, [ebp-4]</span><br><span class="line">.text:565596BB test    eax, eax</span><br><span class="line">.text:565596BD jz      loc_56559E3D</span><br><span class="line">.text:565596C3 jmp     loc_56559727</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>循环大小固定为6，每一轮结束后会test
<code>ebp-4</code>的值，可以看到，初始为1，如果为0，会直接返回。可以看到最终的返回值是<code>ebp-4</code>，也就是说一旦<code>ebp-4</code>为0，就会返回0，循环完毕后它本身可能不变，也就是可能返回1。
看到这里有一些猜想了，这个循环可能是个check，每个循环是个单独的check，通过所有的check才会返回1，应该就拿到flag了，若返回0，可能就gg。
回到main函数验证一下。来到地址<code>5655A3D0</code>，稍微往下几行，看到了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.text:5655A409 test    eax, eax</span><br><span class="line">.text:5655A40B jz      loc_5655ABB9</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>...</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">.text:5655ABB9 loc_5655ABB9:                           ; CODE XREF: .text:5655A40B↑j</span><br><span class="line">.text:5655ABB9 mov     eax, offset aTryAgain           ; &quot;Try again!&quot;</span><br><span class="line">.text:5655ABBE push    eax</span><br><span class="line">.text:5655ABBF nop</span><br><span class="line">.text:5655ABC0 nop</span><br><span class="line">.text:5655ABC1 nop</span><br><span class="line">.text:5655ABC2 nop</span><br><span class="line">.text:5655ABC3 nop</span><br><span class="line">.text:5655ABC4 nop</span><br><span class="line">.text:5655ABC5 nop</span><br><span class="line">.text:5655ABC6 nop</span><br><span class="line">.text:5655ABC7 nop</span><br><span class="line">.text:5655ABC8 nop</span><br><span class="line">.text:5655ABC9 call    near ptr _IO_puts</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>果然如猜想一般，如果返回0就Try again!了。
如果返回1会怎样，继续往下看，又是一个循环，直接到循环结束的地方，<code>loc_5655AB90</code>，可以看到这里输出了flag</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">.text:5655AB90 loc_5655AB90:                           ; CODE XREF: .text:5655A55A↑j</span><br><span class="line">.text:5655AB90 lea     eax, [ebp-180h]</span><br><span class="line">.text:5655AB96 push    eax</span><br><span class="line">.text:5655AB97 mov     eax, offset aHereIsYourFlag     ; &quot;Here is your flag: %s\n&quot;</span><br><span class="line">.text:5655AB9C push    eax</span><br><span class="line">.text:5655AB9D nop</span><br><span class="line">.text:5655AB9E nop</span><br><span class="line">.text:5655AB9F nop</span><br><span class="line">.text:5655ABA0 nop</span><br><span class="line">.text:5655ABA1 nop</span><br><span class="line">.text:5655ABA2 nop</span><br><span class="line">.text:5655ABA3 nop</span><br><span class="line">.text:5655ABA4 nop</span><br><span class="line">.text:5655ABA5 nop</span><br><span class="line">.text:5655ABA6 nop</span><br><span class="line">.text:5655ABA7 call    near ptr _IO_printf</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>我们试一试直接修改check的返回值为1，然后f9。
当然不会输出正确的flag，而是输出了一串乱码。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Input your key:31313131</span><br><span class="line">Here is your flag: o�<span class="comment">#k����,��19�\���К?�q</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>总结一下程序流程：</p>
<ol type="1">
<li>输入若干个十六进制数，在10 15 11 14 12 13 20 25 21 24 22 23 30 35 31
34 32 33 之内。</li>
<li>根据输入，进行了一些“操作”</li>
<li>check结果</li>
<li>可能对结果又进行了一些计算，得到flag</li>
<li>打印flag，或是try again</li>
</ol>
<h4 id="算法">算法</h4>
<p>让我们来看看程序到底干了什么 重新调试，这回输入10151114测试
我么把位于565589C7的函数重命名为<code>operate</code>，位于<code>56559638</code>的函数重命名为<code>check</code>
operate函数下断，跟进到10对应的分支<code>5655BD47</code>，我们把每个这种操作函数按重命名为operate+输入的字节，如<code>operate10</code>
慢慢步入，主体是一个长度为3的循环。
在5655BE7C发现取了一个data段的地址，跟入发现是一连串数据。稍微分析一下这里的结构。在下面一点发现了一连串的指针，直接打开后为修改的ida数据库是这样的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">.data:00013200 off_13200       dd offset dword_13020   ; DATA XREF: .text:00004796↑o</span><br><span class="line">.data:00013200                                         ; .text:000055DF↑o ...</span><br><span class="line">.data:00013204                 dd offset unk_13044</span><br><span class="line">.data:00013208                 dd offset unk_13068</span><br><span class="line">.data:0001320C                 dd offset unk_1308C</span><br><span class="line">.data:00013210                 dd offset unk_130B0</span><br><span class="line">.data:00013214                 dd offset unk_130D4</span><br><span class="line">.data:00013218 off_13218       dd offset unk_130F8     ; DATA XREF: .text:00005701↑o</span><br><span class="line">.data:00013218                                         ; .text:00005722↑o ...</span><br><span class="line">.data:0001321C                 dd offset unk_1311C</span><br><span class="line">.data:00013220                 dd offset unk_13140</span><br><span class="line">.data:00013224                 dd offset unk_13164</span><br><span class="line">.data:00013228                 dd offset unk_13188</span><br><span class="line">.data:0001322C                 dd offset unk_131AC</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这一连串的指针，中间刚好隔了0x24字节，即9个int，一共12个指针。根据题目名叫matrix，猜测是个矩阵，感觉每个元素是int的概率比较大，这里先是猜的，也就是12*9的一个矩阵。注意到这12行是分开来的，也就是说有可能是两个6*9的矩阵。
指针和矩阵中间又有12个int数据。这个矩阵和数据到底是做什么的暂时不知道，继续往下分析。
之前说了，这道题充斥着很多冗余代码，比如刚刚引用这个矩阵的代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.text:5655BE7C mov     ebx, offset matrix</span><br><span class="line">.text:5655BE81 adc     ebx, edx</span><br><span class="line">.text:5655BE83 sbb     eax, ebx</span><br><span class="line">.text:5655BE85 lea     ebx, [eax]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>调试一下可以发现，最终ebx被幅值成了ebx的反，这根本没有意义。
随后的一个对矩阵的引用也是如此，再下一个有些许不同了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">.text:5655BEE5 mov     ecx, offset matrix</span><br><span class="line">.text:5655BEEA add     ecx, eax</span><br><span class="line">.text:5655BEEC mov     eax, [ebp-4]</span><br><span class="line">.text:5655BEEF sbb     eax, edx</span><br><span class="line">.text:5655BEF1 add     eax, eax</span><br><span class="line">.text:5655BEF3 mov     eax, 0B4D418C0h</span><br><span class="line">.text:5655BEF8 lea     eax, [esi]</span><br><span class="line">.text:5655BEFA mov     eax, dword_5656829C</span><br><span class="line">.text:5655BF00 shl     eax, 0</span><br><span class="line">.text:5655BF03 add     eax, 0BE8634ABh</span><br><span class="line">.text:5655BF09 sub     eax, 70A1214Ch</span><br><span class="line">.text:5655BF0F sub     eax, 0CC322C9Bh</span><br><span class="line">.text:5655BF15 add     ecx, eax</span><br><span class="line">.text:5655BF17 xor     edx, eax</span><br><span class="line">.text:5655BF19 mov     ebx, 9F145970h</span><br><span class="line">.text:5655BF1E lea     ebx, [ebx-51A2725Fh]</span><br><span class="line">.text:5655BF24 lea     ebx, [edx+ebp*4-46h]</span><br><span class="line">.text:5655BF28 mov     edx, ecx</span><br><span class="line">.text:5655BF2A add     edx, edx</span><br><span class="line">.text:5655BF2C mov     ebx, 89B03C42h</span><br><span class="line">.text:5655BF31 lea     eax, [edi+7A2658Bh]</span><br><span class="line">.text:5655BF37 lea     eax, [eax-52554450h]</span><br><span class="line">.text:5655BF3D mov     eax, [ecx]</span><br><span class="line">.text:5655BF3F mov     [ebp-4], eax</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在ida里有相同字符的高亮，可以看出，ecx先后加了两个数据，然后终于取数据了，这里取得是matrix+8，也就是第2个元素，紧跟着存入了[ebp-4]
不难发现，形如mov
xxx,[xxx]的代码是可疑代码，有可能是真正有用的部分，分析时要重点关注这样的代码。
比如在<code>5655C12C</code>发现了这样一处代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.text:5655C12C mov     eax, [edx]</span><br><span class="line">.text:5655C12E mov     [ecx], eax</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>通过寄存器看到edx是matrix+BC的地址，也就是matrix[47]，而ecx指向的是之前的matrix[2]，这里有点像元素交换对不对，先把matrix[2]放到一个temp里，然后再把matrix[47]放到matrix[2]里
类似的，在<code>5655C374</code>又有一处代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.text:5655C374 mov     eax, [edx]</span><br><span class="line">.text:5655C376 mov     [ecx], eax</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这里应该是 matrix[47] = matrix[11]，所以不是交换元素了，继续看
又在下面发现了 matrix[11] = matrix[38] 最后，在结束循环之前，看到了
matrix[38] = temp，即是之前的matrix[2] 合并一下，本次循环做的事：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">temp = matrix[<span class="number">2</span>]</span><br><span class="line">matrix[<span class="number">2</span>] = matrix[<span class="number">47</span>]</span><br><span class="line">matrix[<span class="number">47</span>] = matrix[<span class="number">11</span>]</span><br><span class="line">matrix[<span class="number">11</span>] = matrix[<span class="number">38</span>]</span><br><span class="line">matrix[<span class="number">38</span>] = temp</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>接下来两次循环干的应该是相似的事情了。
大胆猜测一下，其他17种操作应该也是某种变换。验证一下，一口气输完所有的18种输入，记录一下操作之前的矩阵，以及操作之后的矩阵
对比前后矩阵不难发现，虽然元素都被打乱了，但是元素的种类都没改变，还是之前的6*9个元素。
同时，matrix下面的一个6*9的矩阵没有被改变，应该是个常量，命名为constant好了
分析了两个变换之后，发现不出什么规律，比赛时就没有继续分析下去的动力了。
赛后想到一个可能好一点的分析方式，先将矩阵的内容patch成0-54的编号，每次输入一个不同的输入，分别记录下每次操作后的矩阵，再分析是怎么变化的。
试试换条思路，根据程序的流程，进行完操作之后是check，而操作的过程中矩阵元素的大小没有改变，只改变了元素的位置，我们有没有办法构造出最终过check的矩阵呢？</p>
<p>进入check函数看看如何check的：
循环长度为6，假设刚好对应了矩阵的每一行，
与之前变换的时候访问矩阵元素不太一样，这里是通过后面的6个指向矩阵的每一行的指针来访问元素的
用跟之前相似的方法，在<code>5655984A</code>发现了这样的代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.text:5655984A mov     edx, [eax]</span><br><span class="line">.text:5655984C mov     eax, [ecx]</span><br><span class="line">.text:5655984E add     edx, eax</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这里加的是matrix[0]和matrix[2]</p>
<p>接下来跟着edx走不难发现一些类似的代码，最终的效果就是</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">temp = matrix[<span class="number">0</span>]+matrix[<span class="number">2</span>]+matrix[<span class="number">4</span>]+matrix[<span class="number">6</span>]+matrix[<span class="number">8</span>]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>刚好把偶数下标的元素求和了，然后不远处又能发现</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">.text:56559A8B cmp     edx, eax</span><br><span class="line">.text:56559A8D mov     eax, 0</span><br><span class="line">.text:56559A92 setz    al</span><br><span class="line">.text:56559A95 mov     ecx, [ebp-4]</span><br><span class="line">.text:56559A98 and     ecx, eax</span><br><span class="line">.text:56559A9A mov     eax, ecx</span><br><span class="line">.text:56559A9C adc     eax, ebx</span><br><span class="line">.text:56559A9E lea     eax, [esi]</span><br><span class="line">.text:56559AA0 sbb     edx, edx</span><br><span class="line">.text:56559AA2 sub     eax, ecx</span><br><span class="line">.text:56559AA4 mov     edx, 51160ED1h</span><br><span class="line">.text:56559AA9 lea     edx, [esi+2Ah]</span><br><span class="line">.text:56559AAC mov     ebx, 66600294h</span><br><span class="line">.text:56559AB1 lea     eax, [ebx+0Fh]</span><br><span class="line">.text:56559AB4 mov     eax, 0F4B4E967h</span><br><span class="line">.text:56559AB9 mov     eax, 13E96DD7h</span><br><span class="line">.text:56559ABE lea     edx, [esp+edi*4-0Dh]</span><br><span class="line">.text:56559AC2 mov     [ebp-4], ecx</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这里的edx是求和的结果，eax跟过去一看，是之前那12个不知道有啥用的数据中的第一个，命名为cmp好了。
比较的结果果然被放在了[eb-4]中
继续往下跟，不难看到第二个比较，不同的，这次求和的内容并不是奇数下标的元素，而是</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">temp = matrix[<span class="number">1</span>]+matrix[<span class="number">3</span>]+matrix[<span class="number">4</span>]+matrix[<span class="number">5</span>]+matrix[<span class="number">6</span>]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在两次过程中matrix[4]都被加进去了，最终比较的对象是cmp[1]
猜测一下check过程。cmp是个6*2的矩阵。每次比较matrix的每一行，下标为02468的元素求和要为cmp[i][0]，下标为13457的元素求和要为cmp[i][1]
稍微验证一下之后的循环，下标果然如此</p>
<h4 id="穷举求解">穷举求解</h4>
<p>既然相加的元素都在这6*9个之中，我们只要找到某5个元素，加和等于cmp就行了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> *</span><br><span class="line">a = [i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">54</span>)]</span><br><span class="line">mat = [<span class="number">0x0FDFE0BA1</span>, <span class="number">0x9A915052</span>, <span class="number">0x0C96F3527</span>, <span class="number">0x0F5201FCD</span>, <span class="number">0x0FE32ED8F</span>, <span class="number">0x0DB8E3EF9</span>, <span class="number">0x51EF954</span>, <span class="number">0x0FE217F1C</span>, <span class="number">0x7B33A8BB</span>, <span class="number">0x9CF903A1</span>, <span class="number">0x0C381E2CD</span>, <span class="number">0x22B35BE4</span>, <span class="number">0x4550E6AE</span>, <span class="number">0x0DC9E8F3C</span>, <span class="number">0x0A9B44EAF</span>, <span class="number">0x3372486A</span>, <span class="number">0x51329F58</span>, <span class="number">0x5F2F456E</span>, <span class="number">0x9B555A08</span>, <span class="number">0x0EB1A8529</span>, <span class="number">0x9B009084</span>, <span class="number">0x9B0B7B06</span>, <span class="number">0x9967F311</span>, <span class="number">0x91FB13AB</span>, <span class="number">0x18952236</span>, <span class="number">0x6F7B9915</span>, <span class="number">0x0EDD9D6D1</span>, <span class="number">0x0FB67FE21</span>, <span class="number">0x259911B0</span>, <span class="number">0x3DC4EE74</span>, <span class="number">0x98936FF0</span>, <span class="number">0x0DF7502CE</span>, <span class="number">0x0C3DF1016</span>, <span class="number">0x0BC1220F9</span>, <span class="number">0x0F54C810C</span>, <span class="number">0x715A634C</span>, <span class="number">0x3E1637A6</span>, <span class="number">0x80F07B8D</span>, <span class="number">0x0FB9CA491</span>, <span class="number">0x0AD254C2E</span>, <span class="number">0x0FB5A012F</span>, <span class="number">0x1AEF5581</span>, <span class="number">0x0B9CC1351</span>, <span class="number">0x9A3B536D</span>, <span class="number">0x0BD7FAF0F</span>, <span class="number">0x0F49AD883</span>, <span class="number">0x2C55324</span>, <span class="number">0x83BC3205</span>, <span class="number">0x43846281</span>, <span class="number">0x19382448</span>, <span class="number">0x0FADB2B18</span>, <span class="number">0x9335D185</span>, <span class="number">0x94C6BF5A</span>, <span class="number">0x591685AE</span>]</span><br><span class="line">m = combinations(a,<span class="number">5</span>)</span><br><span class="line">res = [[<span class="number">0x0D481DD44</span>, <span class="number">0x0E66CF0E0</span>], [<span class="number">0x6C86565D</span>, <span class="number">0x0EF6C2A6D</span>], [<span class="number">0x0D170230A</span>, <span class="number">0x9159B169</span>], [<span class="number">0x3DCF0D3F</span>, <span class="number">0x0D9331E76</span>], [<span class="number">0x64691AF0</span>, <span class="number">0x0DBF384CF</span>], [<span class="number">0x69E3E3A</span>, <span class="number">0x7122DE4D</span>]]</span><br><span class="line"><span class="comment"># get part of result</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> m:</span><br><span class="line">    summ = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> i:</span><br><span class="line">        summ+=mat[j]</span><br><span class="line">    summ&amp;=<span class="number">0xffffffff</span></span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(res)):</span><br><span class="line">        <span class="keyword">if</span> summ == res[k][<span class="number">0</span>]:</span><br><span class="line">            <span class="built_in">print</span>(k,<span class="number">0</span>)</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> i:</span><br><span class="line">                <span class="built_in">print</span>(<span class="built_in">hex</span>(mat[j]))</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> summ == res[k][<span class="number">1</span>]:</span><br><span class="line">            <span class="built_in">print</span>(k,<span class="number">1</span>)</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> i:</span><br><span class="line">                <span class="built_in">print</span>(<span class="built_in">hex</span>(mat[j]))</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="comment"># then combine these output in Notepad++, get the a</span></span><br><span class="line">exit()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>把输出稍微整理一下，选出同一行有相同元素的（matrix[4]），把相同元素提取出来，得到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">(0, 0)			(0, 1)</span><br><span class="line">0xfdfe0ba1L     0x51329f58</span><br><span class="line">0x7b33a8bb      0x6f7b9915</span><br><span class="line">0x3dc4ee74      0x2c55324</span><br><span class="line">0x3e1637a6      0x43846281</span><br><span class="line"></span><br><span class="line">0xdf7502ce</span><br><span class="line"></span><br><span class="line">(1, 0)			(1, 1)</span><br><span class="line">0xc96f3527L     0xf5201fcdL</span><br><span class="line">0x51ef954       0xdb8e3ef9L</span><br><span class="line">0x715a634c      0xeb1a8529L</span><br><span class="line">0x9335d185L     0x9a3b536dL</span><br><span class="line"></span><br><span class="line">0x9967f311L,</span><br><span class="line"></span><br><span class="line">(2, 0)			(2, 1)</span><br><span class="line">0x9b009084L     0xc381e2cdL</span><br><span class="line">0x18952236      0x98936ff0L</span><br><span class="line">0xbd7faf0fL     0xc3df1016L</span><br><span class="line">0x83bc3205L     0x94c6bf5aL</span><br><span class="line"></span><br><span class="line">0xdc9e8f3cL,</span><br><span class="line"></span><br><span class="line">(3, 0)			(3, 1)</span><br><span class="line">0x22b35be4      0x91fb13abL</span><br><span class="line">0x3372486a      0x80f07b8dL</span><br><span class="line">0xedd9d6d1L     0xad254c2eL</span><br><span class="line">0xfb9ca491L     0x1aef5581</span><br><span class="line"></span><br><span class="line">0xfe32ed8fL,</span><br><span class="line"></span><br><span class="line">(4, 0)			(4, 1)</span><br><span class="line">0x9cf903a1L     0xfe217f1cL</span><br><span class="line">0x9b555a08L     0xa9b44eafL</span><br><span class="line">0xb9cc1351L     0x259911b0</span><br><span class="line">0x591685ae      0xf54c810cL</span><br><span class="line"></span><br><span class="line">0x19382448,</span><br><span class="line"></span><br><span class="line">(5, 0)			(5, 1)</span><br><span class="line">0x5f2f456e      0x9a915052L</span><br><span class="line">0xfb67fe21L     0x4550e6ae</span><br><span class="line">0xbc1220f9L     0x9b0b7b06L</span><br><span class="line">0xf49ad883L     0xfadb2b18L</span><br><span class="line"></span><br><span class="line">0xfb5a012fL,</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>那么现在问题在于，我们只是得到每一行有哪些元素，并不知道它们是如何排列的，毕竟加法满足交换律。</p>
<p>一行可能的结果数：4! * 4! = 576</p>
<p>由于每一行互相是互不影响的，所以我们只需要穷举576*6种结果，找出其中经过计算得到flag后，有可见字符的结果拼接即可。</p>
<p>一开始我的解决方案是想办法patch程序中的内存，然而找不到好的方法写脚本，所以还得分析计算flag的方法</p>
<p>继续调试，check函数之后就是计算flag了，首先是长度为6的循环，八成是对应矩阵的每一行了</p>
<p>还是根据之前调试的方法，不难发现，先将matrix和constant的行数的指针放到[ebp-184h]和[ebp-188h]</p>
<p>之后进入了一个长度为9的循环，先猜测对应行中的每一个元素</p>
<p>有了先前分析的经验，现在在分析就上手一些了，最终有用的代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">.text:5655A8AC mov     eax, [ebp-8]           ; j</span><br><span class="line">.text:5655A8AF shl     eax, 2</span><br><span class="line">;...</span><br><span class="line">.text:5655A8F2 mov     ecx, [ebp-184h]</span><br><span class="line">.text:5655A8F8 add     ecx, eax</span><br><span class="line">;...</span><br><span class="line">.text:5655A9B6 mov     eax, [ebp-8]</span><br><span class="line">.text:5655A9B9 shl     eax, 2</span><br><span class="line">;...</span><br><span class="line">.text:5655AA01 mov     edx, [ebp-188h]</span><br><span class="line">.text:5655AA07 add     edx, eax</span><br><span class="line">;...</span><br><span class="line">.text:5655AA19 mov     eax, [ecx]</span><br><span class="line">.text:5655AA1B mov     ecx, [edx]</span><br><span class="line">.text:5655AA1D imul    eax, ecx</span><br><span class="line">;...</span><br><span class="line">.text:5655AA95 mov     ecx, [ebp-18Ch]</span><br><span class="line">.text:5655AA9B add     ecx, eax</span><br><span class="line">;...</span><br><span class="line">.text:5655AAC7 mov     [ebp-18Ch], ecx        ; m[i][j]*c[i][j]</span><br><span class="line">.text:5655AACD jmp     loc_5655A818           ; j++</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>其实就是两个矩阵对应元素相乘，同一行再相加</p>
<p>外循环干的事：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.text:5655AB0A mov     eax, [ebp-4]           ; i</span><br><span class="line">.text:5655AB0D shl     eax, 2</span><br><span class="line">;...</span><br><span class="line">.text:5655AB4C lea     ecx, [ebp-180h]        ; flag</span><br><span class="line">.text:5655AB52 add     ecx, eax</span><br><span class="line">;...</span><br><span class="line">.text:5655AB83 mov     eax, [ebp-18Ch]        ; the result of every row</span><br><span class="line">.text:5655AB89 mov     [ecx], eax</span><br><span class="line">.text:5655AB8B jmp     loc_5655A565           ; i++</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>那么加完的内容就是最后要输出的东西了，开始穷举：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> *</span><br><span class="line">res = [[<span class="number">0x0D481DD44</span>, <span class="number">0x0E66CF0E0</span>], [<span class="number">0x6C86565D</span>, <span class="number">0x0EF6C2A6D</span>], [<span class="number">0x0D170230A</span>, <span class="number">0x9159B169</span>], [<span class="number">0x3DCF0D3F</span>, <span class="number">0x0D9331E76</span>], [<span class="number">0x64691AF0</span>, <span class="number">0x0DBF384CF</span>], [<span class="number">0x69E3E3A</span>, <span class="number">0x7122DE4D</span>]]</span><br><span class="line">constmat = [<span class="number">0x0B849CD19</span>, <span class="number">0x55E00017</span>, <span class="number">0x844966B</span>, <span class="number">0x80C181EC</span>, <span class="number">0x686C0B3C</span>, <span class="number">0x55400592</span>, <span class="number">0x0CD42168A</span>, <span class="number">0x4039E81</span>, <span class="number">0x0D9DE549F</span>, <span class="number">0x2034677D</span>, <span class="number">0x144ABD</span>, <span class="number">0x49100D00</span>, <span class="number">0x0E003A0E0</span>, <span class="number">0x80F0006D</span>, <span class="number">0x8307ADD6</span>, <span class="number">0x4CF60781</span>, <span class="number">0x0A0352643</span>, <span class="number">0x0C580C3DE</span>, <span class="number">0x0EA8C4E24</span>, <span class="number">0x68603008</span>, <span class="number">0x687FBFFF</span>, <span class="number">0x19DE4BF9</span>, <span class="number">0x271A1179</span>, <span class="number">0x99791C4D</span>, <span class="number">0x29CBFFC</span>, <span class="number">0x2B82801E</span>, <span class="number">0x3C0307FB</span>, <span class="number">0x0DAE61CD6</span>, <span class="number">0x8F7B1BF0</span>, <span class="number">0x0C56CEF1D</span>, <span class="number">0x0D6493A96</span>, <span class="number">0x1808018</span>, <span class="number">0x0F48001B9</span>, <span class="number">0x3712519</span>, <span class="number">0x9294F318</span>, <span class="number">0x6DE20384</span>, <span class="number">0x0F3750B04</span>, <span class="number">0x256A122A</span>, <span class="number">0x257290B</span>, <span class="number">0x0C4582056</span>, <span class="number">0x204E8BC0</span>, <span class="number">0x79C7ADE7</span>, <span class="number">0x0C4C20203</span>, <span class="number">0x5B961570</span>, <span class="number">0x66034856</span>, <span class="number">0x78329E3A</span>, <span class="number">0x1D07C00</span>, <span class="number">0x4AC240E6</span>, <span class="number">0x854CFBBE</span>, <span class="number">0x0ABFEC404</span>, <span class="number">0x5BD80037</span>, <span class="number">0x0E94CBCD8</span>, <span class="number">0x1</span>, <span class="number">0x0C4CA280D</span>]</span><br><span class="line">a= [[[<span class="number">0xfdfe0ba1</span>, <span class="number">0x7b33a8bb</span>, <span class="number">0x3dc4ee74</span>, <span class="number">0x3e1637a6</span>],[<span class="number">0x51329f58</span>, <span class="number">0x6f7b9915</span>, <span class="number">0x2c55324</span>, <span class="number">0x43846281</span>],<span class="number">0xdf7502ce</span>],[[<span class="number">0xc96f3527</span>, <span class="number">0x51ef954</span>, <span class="number">0x715a634c</span>, <span class="number">0x9335d185</span>], [<span class="number">0xf5201fcd</span>, <span class="number">0xdb8e3ef9</span>, <span class="number">0xeb1a8529</span>, <span class="number">0x9a3b536d</span>],<span class="number">0x9967f311</span>],[[<span class="number">0x9b009084</span>, <span class="number">0x18952236</span>, <span class="number">0xbd7faf0f</span>, <span class="number">0x83bc3205</span>], [<span class="number">0xc381e2cd</span>, <span class="number">0x98936ff0</span>, <span class="number">0xc3df1016</span>, <span class="number">0x94c6bf5a</span>], <span class="number">0xdc9e8f3c</span>],[[<span class="number">0x22b35be4</span>, <span class="number">0x3372486a</span>, <span class="number">0xedd9d6d1</span>, <span class="number">0xfb9ca491</span>], [<span class="number">0x91fb13ab</span>, <span class="number">0x80f07b8d</span>, <span class="number">0xad254c2e</span>, <span class="number">0x1aef5581</span>], <span class="number">0xfe32ed8f</span>],[[<span class="number">0x9cf903a1</span>, <span class="number">0x9b555a08</span>, <span class="number">0xb9cc1351</span>, <span class="number">0x591685ae</span>], [<span class="number">0xfe217f1c</span>, <span class="number">0xa9b44eaf</span>, <span class="number">0x259911b0</span>, <span class="number">0xf54c810c</span>], <span class="number">0x19382448</span>],[[<span class="number">0x5f2f456e</span>, <span class="number">0xfb67fe21</span>, <span class="number">0xbc1220f9</span>, <span class="number">0xf49ad883</span>], [<span class="number">0x9a915052</span>, <span class="number">0x4550e6ae</span>, <span class="number">0x9b0b7b06</span>, <span class="number">0xfadb2b18</span>], <span class="number">0xfb5a012f</span>]]</span><br><span class="line">m = permutations([<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>],<span class="number">4</span>)</span><br><span class="line">n = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> m:</span><br><span class="line">    n.append(i)</span><br><span class="line">cont = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">6</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;#########part %d#########&#x27;</span>%i)</span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> n:</span><br><span class="line">        <span class="keyword">for</span> q <span class="keyword">in</span> n:</span><br><span class="line">            cont+=<span class="number">1</span></span><br><span class="line">            ress = <span class="string">&#x27;&#x27;</span></span><br><span class="line">            resr = []</span><br><span class="line">            resr.append(a[i][<span class="number">0</span>][p[<span class="number">0</span>]])</span><br><span class="line">            resr.append(a[i][<span class="number">1</span>][q[<span class="number">0</span>]])</span><br><span class="line">            resr.append(a[i][<span class="number">0</span>][p[<span class="number">1</span>]])</span><br><span class="line">            resr.append(a[i][<span class="number">1</span>][q[<span class="number">1</span>]])</span><br><span class="line">            resr.append(a[i][<span class="number">2</span>])</span><br><span class="line">            resr.append(a[i][<span class="number">1</span>][q[<span class="number">2</span>]])</span><br><span class="line">            resr.append(a[i][<span class="number">0</span>][p[<span class="number">2</span>]])</span><br><span class="line">            resr.append(a[i][<span class="number">1</span>][q[<span class="number">3</span>]])</span><br><span class="line">            resr.append(a[i][<span class="number">0</span>][p[<span class="number">3</span>]])</span><br><span class="line">            sumr = <span class="number">0</span></span><br><span class="line">            check0 = resr[<span class="number">0</span>]+resr[<span class="number">2</span>]+resr[<span class="number">4</span>]+resr[<span class="number">6</span>]+resr[<span class="number">8</span>]</span><br><span class="line">            check0&amp;=<span class="number">0xffffffff</span></span><br><span class="line">            check1 = resr[<span class="number">1</span>]+resr[<span class="number">3</span>]+resr[<span class="number">4</span>]+resr[<span class="number">5</span>]+resr[<span class="number">7</span>]</span><br><span class="line">            check1&amp;=<span class="number">0xffffffff</span></span><br><span class="line">            <span class="keyword">if</span>  check0 != res[i][<span class="number">0</span>]:</span><br><span class="line">                <span class="built_in">print</span>(i)</span><br><span class="line">                <span class="keyword">for</span> k <span class="keyword">in</span> resr:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="built_in">hex</span>(k))</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="built_in">hex</span>(check0))</span><br><span class="line">                <span class="built_in">print</span>(<span class="built_in">hex</span>(res[i][<span class="number">0</span>]))</span><br><span class="line">                <span class="built_in">print</span>(p)</span><br><span class="line">                <span class="built_in">print</span>(q)</span><br><span class="line">                exit()</span><br><span class="line">            <span class="keyword">assert</span> check0 == res[i][<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">assert</span> check1 == res[i][<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(resr)):</span><br><span class="line">                sumr+=resr[k]*constmat[i*<span class="number">9</span>+k]</span><br><span class="line">                sumr&amp;=<span class="number">0xFFFFFFFF</span></span><br><span class="line">            ff = <span class="number">0</span></span><br><span class="line">            <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">                temp = sumr&amp;<span class="number">0xFF</span></span><br><span class="line">                <span class="keyword">if</span> temp &lt; <span class="number">0x20</span> <span class="keyword">or</span> temp &gt;= <span class="number">0x7f</span>:</span><br><span class="line">                    ff = <span class="number">1</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                ress+=<span class="built_in">chr</span>(temp)</span><br><span class="line">                sumr&gt;&gt;=<span class="number">8</span></span><br><span class="line">            <span class="keyword">if</span> ff == <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="built_in">print</span>(ress)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>把输出按语义拼接一下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&gt;uG8   \w8]   J|@&gt;   Oh)!   ye$B   ukxG</span><br><span class="line">xU&quot;a   Gj3o   S_Cu   &#125;]nU   h`1)   uHnr</span><br><span class="line">W8F?   &#123;7h1   X4G\   63_i   *[T3   ;73-</span><br><span class="line">P[jk   KP6o   Xp,T   -gF:   s_m4   a/_j</span><br><span class="line">|/Zj   v9E[   oeps   -S96   \Q&#125;]   g1c&#125;</span><br><span class="line">:!);   B::(   &#x27;-SR   ERNJ   gJO(   AR&amp;|</span><br><span class="line">*CTF   a&#x27;/0   SA;V   nL?K   SZL    4nEE</span><br><span class="line">uP@J   uk6W   @GhI   RV&amp;b   &quot;-R!   YOcm</span><br><span class="line">erkU   XP#3          2\t$   5zB(   AkT6</span><br><span class="line">Mc=F   hx-A          Q7^&lt;          -l/l</span><br><span class="line">;|.b   X .;          &lt;1I7          YctL</span><br><span class="line">=!M3   4gjL          1I@B          VRae</span><br><span class="line">A6V\   /_&quot;u          jke&amp;</span><br><span class="line">k?!R   ^I;-</span><br><span class="line">       :q(V</span><br><span class="line"></span><br><span class="line">*CTF&#123;7h1S_Cu63_is_m4g1c&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="总结">总结</h4>
<p>因为刚开始学花指令，没找去除冗余代码的方法，脚本写不出来，所以干脆就纯看汇编做的，感觉方法比较蠢，需要胆大心细，但是做的过程中也多多少少对这种混淆的方法有了一定的了解，有空的话深究一下高级一点去花方法。</p>
<p>此外，比赛时并没有发现这道题的算法是什么，赛后跟大牛交流了一下其实这是一个魔方，6*9个元素对应6个面每个面9个块，18种输入对应18种标准魔方的操作，每个面顺时针逆时针旋转90度加3个中间块的两个方向旋转90度。不过知道是魔方之后也想不到有什么很好的解决方法。颜色不知道，最终还原的魔方的状态也不知道，只知道还原的魔方能过check。
还有一点，由于魔方边块和角块必须是挨着的，在矩阵上就能满足某种特定的规则，这样在我之前的穷举时就能去除那些不紧挨的情况了，可能最终的输出会被缩小很多，如果遇到flag没有语义的情况会有优势。</p>
<h2 id="misc">misc</h2>
<h3 id="she">she</h3>
<p>根据提示，杀死左小角小屋内的鸡拿flag。</p>
<p>先跟右下角的女生对话后会不能存档。</p>
<p>存个档，进右上角小屋杀只怪，升一级的点前后再存档，比较两个存档的不同。</p>
<p>再存档内可以看到gold，exp，level等后面的数值不一样。稍微修改一下，发现存数据的规律：</p>
<p>0x69表示类型位整型，下一个字符表示用到多少字节存数据，只用1字节的时候不要，最多四字节，因此所有数据都是5开始的。我们把金钱，经验值调大，进游戏一刀满级，然后去左上角的商店买装备。</p>
<p>然而还是打不过，想了想鸡的攻防可能超过我们已有的最高攻防了。</p>
<p>这是可以改游戏文件，把鸡的攻防调为最低。</p>
<p>在data文件夹内有个叫enemies的文件，在里面可以看到大概是两个敌人，一个叫Julia，就是那只鸡，一个叫Trainer训练假人。</p>
<p>稍微摸索一下数据，看到几个比较关键的比如def，atk等，或者直接干脆把所有的都改成05
或者06。</p>
<p>再去打鸡，可以一刀秒了。</p>
<p>接下来还不能直接拿flag，根据提示，打开所有的门中的宝箱。有些门不能直接开，开完后面的门才能开。基本这里就是比走位躲幽灵的时间了。</p>
<p>所有门开完后最后的多了个门，里面提示把之前宝箱内的数字连起来md5即是flag。</p>
<p>数字要按顺序从左到右</p>
<p>213697</p>
<p>*ctf{d6f3fdffbcb462607878af65d059f274}</p>
<h3 id="otaku">otaku</h3>
<p>下载下来是一个文档Anime_Intro.doc和压缩包flag.zip，压缩包加密了</p>
<p>文档打开后是一段英文，稍微看一下内容，讲的是紫罗兰永恒花园。注意到一些地方格式不太对，有几个字符是空白的。把空白字符复制到谷歌文档里竟然多了很多东西，很迷。。。</p>
<p>也可以把doc用压缩包打开，在xml里面能看到少的东西，是另外一串字符串。大意是个梗，跟炉石有关，差不多就是要388去救薇尔莉特之类的balabala。。。先不管</p>
<p>去看flag.zip，里面有张图片和一个叫last
words的txt，txt的大小为432字节。之前隐藏的一部分文字大概也就这么长，复制到txt里看一下，然而却有433字节，用010
editor打开，发现有个地方不太对，有个I'm的单引号占了三个字节，如果是英文引号的话应该占1个字节，那么大小应该为431字节（一共确实是有431个字符）。而zip里的txt有432字节，这里用的确实是中文引号，那只能是编码方式的问题了。用notepad++的转码功能，注意是转码，而不是上面的编码，转码乘ascii，中文部分会自动用gbk编码，这样得到的txt就有432字节了，大小跟zip内的一样，考虑明文攻击。</p>
<figure>
<img src="/2019/05/02/2019starctf/2019starctf01.jpg" alt="2019starctf01">
<figcaption aria-hidden="true">2019starctf01</figcaption>
</figure>
<p>在制作zip的时候踩了很多坑，最后得出结论：</p>
<p>同为zip压缩，7z和winrar的结果竟然不同，就算所有的设置都一样，压缩结果也不同！而且这里的不同不仅是时间这些无关紧要的东西不同，是最终压缩结果的压缩数据都不一样！这里坑了很久。然后试了很多压缩软件，只有winrar的跟其他的不一样！7z，好压，linux命令行压缩等的结果都是一样的，这里确实是被坑了。。。</p>
<p>最后使用winrar制作的zip，azpr一把梭，得到密码解开zip，拿出图片。</p>
<p>图片是紫罗兰永恒花园的角色薇尔莉特。然后直接lsb隐写得到结果。</p>
<p>队里队友用zsteg工具一把梭，然而我怎么都搞不好环境，跑不起来。。。只好用stegsolve了</p>
<p>这题还是挺有意思的，彩蛋很多，做起来挺欢乐的。然而比赛时都去刚re了，这题最终是阿烨出的。</p>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>Apeng
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="http://apeng.re/2019/05/02/2019starctf/" title="2019 *CTF">http://apeng.re/2019/05/02/2019starctf/</a>
  </li>
  <li class="post-copyright-license">
      <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-ND</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/Go/" rel="tag"># Go</a>
              <a href="/tags/%E8%8A%B1%E6%8C%87%E4%BB%A4/" rel="tag"># 花指令</a>
              <a href="/tags/%E9%A6%99%E5%86%9C-%E8%8C%83%E8%AF%BA%E7%BC%96%E7%A0%81/" rel="tag"># 香农-范诺编码</a>
              <a href="/tags/%E6%B7%B7%E6%B7%86/" rel="tag"># 混淆</a>
              <a href="/tags/%E8%AF%8D%E6%B3%95%E5%88%86%E6%9E%90%E5%99%A8/" rel="tag"># 词法分析器</a>
              <a href="/tags/lsb/" rel="tag"># lsb</a>
              <a href="/tags/zip/" rel="tag"># zip</a>
              <a href="/tags/doc/" rel="tag"># doc</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2019/04/23/2019ciscn_quals/" rel="prev" title="2019 CISCN 线上赛">
                  <i class="fa fa-angle-left"></i> 2019 CISCN 线上赛
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2019/05/20/2019rctf/" rel="next" title="2019 RCTF">
                  2019 RCTF <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2023</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Apeng</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/Apeng7364" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  






  




  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>



</body>
</html>
